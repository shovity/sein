(()=>{var e={41:()=>{Array.prototype.sum=function(){return this.reduce(((e,t)=>e+t))},HTMLElement.prototype.addClass=function(e){new RegExp(`^${e}$|^${e} | ${e}$| ${e}( )`,"g").test(this.className)||(this.className=`${this.className} ${e}`.trim())},HTMLElement.prototype.removeClass=function(e){const t=new RegExp(`^${e}$|^${e} | ${e}$| ${e}( )`,"g");this.className=this.className.replace(t,"$1").trim()},HTMLCollection.prototype.toArray=function(){return[...this]},NodeList.prototype.toArray=function(){return[...this]}}},t={};function o(n){var a=t[n];if(void 0!==a)return a.exports;var r=t[n]={exports:{}};return e[n](r,r.exports,o),r.exports}(()=>{"use strict";o(41);const e=["debug","info","warning","error"],t={log_level:"debug",get debug(){return e.indexOf(this.log_level.toLowerCase())<=e.indexOf("debug")?console.debug.bind(window.console,"%cDEBUG  :","color: #6c757d"):()=>{}},get info(){return e.indexOf(this.log_level.toLowerCase())<=e.indexOf("info")?console.info.bind(window.console,"%cINFO   :","color: #17a2b8"):()=>{}},get warning(){return e.indexOf(this.log_level.toLowerCase())<=e.indexOf("warning")?console.warn.bind(window.console,"%cWARNING:","color: #ffc107"):()=>{}},get error(){return e.indexOf(this.log_level.toLowerCase())<=e.indexOf("error")?console.error.bind(window.error,"%cERROR  :","color: #dc3545"):()=>{}}},n=new Proxy({},{get:(e,o)=>{if("origin"===o)return e;const n=window.localStorage[o];try{return n&&JSON.parse(n)}catch(e){return t.error("storage: Parse json fail, key: ",o)}},set:(e,t,o)=>(window.localStorage[t]=JSON.stringify(o),e[t]=o,!0)}),a={default:{wallpapers:[{url:"img/w0.jpg",video:0,active:!0},{url:"img/w1.jpg",video:1},{url:"img/w2.jpg",video:2}],local:{wallpaper_videos_0:"video/w0.mp4",wallpaper_videos_1:"video/w1.mp4",wallpaper_videos_2:"video/w2.mp4"}},init:()=>{const e=a.default.wallpapers;return chrome.storage.local.set({...a.default.local,wallpapers:e.concat(Array(9).fill({url:"img/placeholder.png",editbale:!0}))}),a.cache(e)},cache:e=>{try{const t=e.filter((e=>e.active));return n.wallpapers=t,t}catch(e){throw alert("The value of wallpapers exceeded the quota"),e}},boot:()=>{const e=n.wallpapers||a.init(),t=e[Math.floor(Math.random()*e.length)];t&&(window.wall.style.backgroundImage=`url(${t.url})`,t.video>-1&&setTimeout((()=>{const e=`wallpaper_videos_${t.video}`;chrome.storage.local.get(e,(t=>{const o=document.createElement("source");o.src=t[e],o.type="video/mp4",window.wall_video.appendChild(o)}))})))}},r=a,i={pool:{},emit:(e,...t)=>{for(const o of i.pool[e]??[])o(...t)},on:(e,t)=>{i.pool[e]?.push(t)||(i.pool[e]=[t])},next:(e,...t)=>{setTimeout(i.emit,0,e,...t)}},s=i,l={mounted:{},gen:(e,o)=>{if(l[e]||!/^[a-zA-Z][a-zA-Z0-9_]{0,63}$/.test(e))return t.error(`emitter: Name "${e}" existed or invalid`);l[e]=()=>{if(l.mounted[e])return t.error(`emitter: Duplicate mount emitter ${e}`);o(),l.mounted[e]=!0}}};l.gen("click",(()=>{function e(t,o,n=0){if(n>5||!t)return;const a=t.getAttribute("click-emit");if(!a)return e(t.parentElement,o,n+1);const r=a.split(":")[0];let i=a.split(":").slice(1).join(":");if("?"===i[0]){const e={};i.slice(1).split("&").forEach((t=>{const[o,n]=t.split("=");""!==o&&(e[o]=n)})),i=e}s.next(r,i,{target:t,domEvent:o})}window.document.body.addEventListener("click",(t=>{e(t.target,t)})),t.info("emiter: Click emiter mounted")}));const d=l,c={throttle:(e=200,t=!0)=>{const o={lock:!1,handle:null,execute:(n,...a)=>{o.handle=n,o.lock||(o.lock=!0,o.handle(...a),o.handle=null,setTimeout((()=>{o.lock=!1,t&&o.handle&&o.execute(o.handle,...a)}),e))}};return o},debounce:(e=200)=>{const t={timeout:null,execute:(o,...n)=>{clearTimeout(t.timeout),t.timeout=setTimeout(o,e,...n)}};return t},raf:()=>{const e={lock:!1,handle:null,execute:(t,...o)=>{e.handle=t,e.lock||(e.lock=!0,window.requestAnimationFrame((()=>{e.lock=!1,e.handle(...o)})))}};return e}},w={hide:()=>{window.modal.removeClass("modal-show")},show:e=>{window.modal_content.innerHTML=e,window.modal.addClass("modal-show")}};window.modal.addEventListener("click",(({target:e})=>{"modal"===e.id&&w.hide()}));const p=w,u={pull_cooldown:1e4,call:{move:c.raf(),sync:c.throttle(),push:c.debounce(1e3)},version:null,eqCodeReady:null,notes:[]},m=10,h={doNotesOverlap:(e,t)=>e.x<t.x+t.w+m&&e.x+e.w+m>t.x&&e.y<t.y+t.h+m&&e.y+e.h+m>t.y,shiftOverlappingNotes:(e,t)=>{let o=0;for(const n of t)if(h.doNotesOverlap(e,n)){const t=n.x+n.w+m-e.x;o=Math.max(o,t)}return o}};u.fetch=async()=>{const e=await chrome.storage.local.get(["notes","version"]);u.notes=e.notes||[],u.version=e.version,u.render()},u.save=()=>{const e=Date.now();chrome.storage.local.set({notes:u.notes,version:e}),u.version=e,u.call.push.execute(u.push),t.debug("noter: Noter save:",u.notes)},u.createObject=e=>{const t={msg:"",x:Math.floor(Math.random()*(holder.w_w-500)),y:Math.floor(Math.random()*(holder.w_h-250)),w:300,h:100,workspace:n.workspace||0,status:"default"};return Object.assign(t,e)},u.createElement=e=>{const t=document.createElement("div");return t.setAttribute("id",`noteid_${e.id}`),t.setAttribute("class","note"),t.setAttribute("style",`transform: translate(${e.x}px, ${e.y}px)`),t.setAttribute("note-status",e.status||"default"),t.innerHTML=`\n    <div class="note-controls" note-move-id="${e.id}">\n        <div class="note-remove" click-emit="note_remove:${e.id}">&times;</div>\n    </div>\n    <div class="note-rainbow">\n        <div click-emit="note_mark:${e.id},primary"></div>\n        <div click-emit="note_mark:${e.id},success"></div>\n        <div click-emit="note_mark:${e.id},danger"></div>\n    </div>\n    <div class="note-editor"\n        contenteditable="true"\n        spellcheck="false"\n        note-editor-id="${e.id}"\n        style="width:${e.w}px;height:${e.h-20}px"\n    >${e.msg}</div>`,u.handleHashtag(t),t},u.add=e=>{void 0===e.id&&(e.id=Date.now().toString(),e.updatedAt=Date.now(),u.notes.push(e)),window.note_box.appendChild(u.createElement(e))},u.render=(e=!0,o=+n.workspace||0)=>{e&&(window.note_box.innerHTML="");for(const e of u.notes)o===e.workspace&&u.add(e);t.debug("noter: Render note",u.notes)},u.handleEqcode=e=>{const t=window.getSelection(),o=t.getRangeAt(0),n=document.createElement("span");n.id="caret-marker",n.appendChild(document.createTextNode("​")),o.insertNode(n);const a=e.innerHTML;holder.code_tables.forEach((t=>{const o=new RegExp(t.code),n=a.match(o);if(n){const r=n.slice(1);let i=t.value;for(const e of r)i=i.replace("$",e);e.innerHTML=a.replace(o,i)}}));const r=document.getElementById("caret-marker");if(r){const e=document.createRange();e.setStartAfter(r),e.collapse(!0),r.parentNode.removeChild(r),t.removeAllRanges(),t.addRange(e)}},u.handleHashtag=e=>{const t=["note"];(e.querySelector(".note-editor").innerHTML.slice(0,256).match(/#[a-z0-9_]{1,12}/gi)||[]).includes("#mono")&&t.push("note-ffm"),e.className=t.join(" ")},u.remove=e=>{const t=u.notes.findIndex((t=>t.id==e));-1!==n.workspace&&u.notes[t].msg.replace(/(<br>)| /g,"")?(u.notes[t].workspace=-1,u.notes[t].removeAt=Date.now(),u.notes[t].updatedAt=Date.now()):u.notes.splice(t,1);const o=window[`noteid_${e}`];o.parentElement.removeChild(o),u.save()},u.mark=(e,t)=>{const o=u.notes.find((t=>t.id==e));o.status===t?o.status="default":o.status=t,window[`noteid_${e}`].setAttribute("note-status",o.status),u.save()},u.handleOnChange=({target:e,key:t})=>{const o=e.getAttribute("note-editor-id");if(o){const n=u.notes.findIndex((e=>e.id==o));if(u.notes[n].msg===e.innerHTML)return;u.handleHashtag(e.parentElement),"="===t&&(u.eqCodeReady?(u.handleEqcode(e),u.eqCodeReady=!1):u.eqCodeReady=!0),u.notes[n].msg=e.innerHTML,u.notes[n].updatedAt=Date.now(),u.save()}},u.pull=async()=>{if(!n.config.sync_url)return;if(n.pull_date>Date.now()-u.pull_cooldown)return;const[e,t]=n.config.sync_url.split("#"),o=Date.now(),a=u.notes.filter((e=>e.updatedAt>=+n.pull_date)).map((e=>`${e.id}:${e.updatedAt}`)).join(","),r=await fetch(`${e}?date=${n.pull_date||0}&exclude=${a}`,{method:"GET",headers:{"X-Secret":t}}),{data:i}=await r.json();if(i?.length){const e={};let t=!1;for(const t of u.notes)e[t.id]=t;for(const{raw:o}of i)(!e[o.id]?.updatedAt||e[o.id].updatedAt<o.updatedAt)&&(e[o.id]=o,t=!0);t&&(u.notes=Object.values(e),u.render(),u.save())}n.pull_date=o},u.push=async()=>{if(!n.config.sync_url)return;const e=u.notes.filter((e=>+e.updatedAt>(+n.push_date||0)&&e.msg)),t=Date.now(),[o,a]=n.config.sync_url.split("#");e.length&&await fetch(o,{method:"POST",body:JSON.stringify({notes:e}),headers:{"Content-Type":"application/json","X-Secret":a}}),n.push_date=t},u.clearTrash=()=>{n.last_clear_trash>Date.now()-8e7||(n.last_clear_trash=Date.now(),u.notes=u.notes.filter((e=>-1!==e.workspace||e.removeAt>Date.now()-2592e6||void 0)),u.save())},u.sort=(e,o)=>{if(!u.notes.length)return;const a=+n.workspace||0,r=u.notes.filter((e=>e.workspace===a));if(!r.length)return;e||(e=holder.w_w-50),o||(o=holder.w_h);const i=[],s=[...[...r].sort(((e,t)=>t.h-e.h))];let l=m,d=m;for(;s.length>0;){let t=!1;for(let n=0;n<s.length;n++){const a=s[n];if(d+a.h+m<=o){a.x=l,a.y=d;const o=h.shiftOverlappingNotes(a,i);if(o>0&&(a.x+=o,a.x+a.w>e))continue;d+=a.h+m,s.splice(n,1),i.push(a),t=!0;break}}if(!t){let t=!1;if(s.length>0){const n=s[0];for(let a=m;a<=o-n.h;a+=m){for(let o=m;o<=e-n.w;o+=m){n.x=o,n.y=a;let e=!0;for(const t of i)if(h.doNotesOverlap(n,t)){e=!1;break}if(e){t=!0;break}}if(t)break}if(!t){n.x=m,n.y=m;const o=h.shiftOverlappingNotes(n,i);o>0&&n.x+o+n.w<=e&&(n.x+=o,t=!0)}if(t)l=n.x,d=n.y+n.h+m,s.splice(0,1),i.push(n);else{const t=Math.floor(Math.random()*(e-n.w-m))+m,a=Math.floor(Math.random()*(o-n.h-m))+m;n.x=t,n.y=a,l=m,s.splice(0,1),i.push(n)}}}}u.render(),u.save(),t.debug("noter: Sorted notes using column-based packing algorithm with overlap shifting")},u.boot=()=>{const e={resize:!1,move:!1,deltaX:0,deltaY:0};if(s.on("note_remove",(e=>{u.remove(e)})),s.on("note_mark",(e=>{const[t,o]=e.split(",");u.mark(t,o)})),window.note_box.addEventListener("mousedown",(t=>{if(3===t.which)return;const{target:o}=t;if(null!==o.getAttribute("note-editor-id")){const n=t.clientX,a=t.clientY,r=+o.getAttribute("note-editor-id"),i=u.notes.findIndex((e=>e.id==r)),s=u.notes[i];s.x+s.w-n<15&&s.y+s.h-a<15&&(e.resize=r)}if(null!==o.getAttribute("note-move-id")){document.body.style.userSelect="none";const n=+o.getAttribute("note-move-id"),a=u.notes.findIndex((e=>e.id==n));e.deltaX=t.clientX-u.notes[a].x,e.deltaY=t.clientY-u.notes[a].y,e.move=n}})),window.addEventListener("mousemove",(t=>{!1!==e.move&&(t.preventDefault(),u.call.move.execute((()=>{const o=window[`noteid_${e.move}`];if(o){const n=Math.min(holder.w_w-20,Math.max(t.clientX-e.deltaX,0)),a=Math.min(holder.w_h-20,Math.max(t.clientY-e.deltaY,0));o.style.transform=`translate(${n}px, ${a}px)`}})))})),window.addEventListener("mouseup",(t=>{if(document.body.style.userSelect="",!1!==e.move){const o=t.clientX-e.deltaX,n=t.clientY-e.deltaY,a=u.notes.find((t=>t.id==e.move));a&&(a.x=Math.max(0,Math.min(holder.w_w,o)),a.y=Math.max(0,Math.min(holder.w_h,n)),a.updatedAt=Date.now()),e.move=!1,u.save()}else if(!1!==e.resize){const t=u.notes.find((t=>t.id==e.resize));t&&(t.w=window["noteid_"+e.resize].offsetWidth,t.h=window["noteid_"+e.resize].offsetHeight,t.updatedAt=Date.now()),e.resize=!1,u.save()}})),window.note_box.addEventListener("keyup",u.handleOnChange),window.note_box.addEventListener("paste",u.handleOnChange),window.note_box.addEventListener("click",(({target:e})=>{"IMG"===e.tagName&&p.show(`<img src="${e.src}" style="max-width: calc(100vw - 50px)">`)})),s.on("noter_add",(()=>{u.add(u.createObject()),u.save()})),s.on("noter_switch_workspace",(()=>{let e=+n.workspace||0;e>n.config.number_of_workspace-2?e=-1:e++,window.btn_switch_workspace.innerHTML=-1===e?"🗑️":e,n.workspace=e,u.save(),u.render()})),window.btn_sort_note){let e=!1,t=0,o=0;const n=c.throttle(100);window.btn_sort_note.addEventListener("mousedown",(a=>{e=!0,t=a.clientX,o=a.clientY,n.execute((()=>{u.sort()}))})),window.addEventListener("mousemove",(a=>{a.buttons&&e&&(Math.abs(a.clientX-t)<5&&Math.abs(a.clientY-o)<5||(t=a.clientX,o=a.clientY,n.execute((()=>{u.sort(t,o+100)}))))})),window.addEventListener("mouseup",(()=>{e=!1}))}chrome.storage.onChanged.addListener(((e,t)=>{"local"===t&&u.call.sync.execute((()=>{e.notes&&e.version?.newValue>u.version&&(u.notes=e.notes.newValue,u.render())}))})),u.fetch().then((async()=>{u.clearTrash(),await u.push(),await u.pull()}))};const g=u,v={bookmarkBarElement:window.bookmark_bar,create:e=>{const{url:t,title:o,children:n}=e;return n?(setTimeout((()=>v.render(e))),""):`\n    <a class="item" href="${t}">\n        <img src="${chrome.runtime.getURL("/_favicon/")}?pageUrl=${t}">\n        <div class="title">${o}</div>\n    </a>`},createParent:e=>{const t=e.title,o=e.children.map((e=>v.create(e))).join(""),a=`${t}-${e.parentId||"root"}`;return`\n    <div class="parent ${n[`bookmark:parent:${a}`]||"open"}">\n        <div class="parent-header" data-parent-id="${a}">\n            <span class="icon icon-folder"></span>\n            <div class="label">${t}</div>\n        </div>\n        <div class="stopgrap"></div>\n        <div class="parent-childs">${o}</div>\n    </div>`},render:(e,t=!1)=>{t&&(v.bookmarkBarElement.innerHTML=""),v.bookmarkBarElement.innerHTML+=v.createParent(e)},toggleOpenParent:e=>{const t="close"===n[`bookmark:parent:${e}`]?"open":"close";n[`bookmark:parent:${e}`]=t,document.querySelector(`[data-parent-id="${e}"]`).parentNode.className=`parent ${t}`},fetch:()=>{chrome.topSites.get((e=>{v.render({children:e,title:"Most visited"},!0),chrome.bookmarks.getTree((e=>{v.render(e[0].children[0])}))}))},boot:()=>{v.bookmarkBarElement.addEventListener("click",(({target:e})=>{const t=e.getAttribute("data-parent-id")||e.parentNode.getAttribute("data-parent-id");t&&v.toggleOpenParent(t)})),chrome.bookmarks.onCreated.addListener(v.fetch),chrome.bookmarks.onRemoved.addListener(v.fetch),chrome.bookmarks.onChanged.addListener(v.fetch),chrome.bookmarks.onMoved.addListener(v.fetch),v.fetch()}},f=v,_=(e,t)=>{window.wave_click_box.innerHTML=`\n    <div class="wave active" style="transform: translate(${e}px, ${t}px)">\n        <div></div>\n        <div></div>\n        <div></div>\n    </div>`};window.addEventListener("mouseup",(e=>{_(e.clientX,e.clientY)}));const b={isOpen:!1,blob_buffer_url:null,render:()=>{const e=Math.floor(window.settings_wallpapers.clientWidth/6-11),t=Math.floor(e*holder.w_h/holder.w_w);window.settings_wallpapers.innerHTML=Array(12).fill(1).map((()=>`\n            <div class="settings-wall-pre"\n                style="width: ${e}px; height: ${t}px; background-image: url(/img/placeholder.png)"\n            ></div>\n            `)).join(""),chrome.storage.local.get("wallpapers",(({wallpapers:o})=>{window.settings_wallpapers.innerHTML=o.map(((o,n)=>{let a="settings-wall-pre";o.active&&(a+=" active");let r="";return o.editbale&&(r+=`<span click-emit="setting_wallpaper_edit:${n}">EDIT</span>`),`\n                <div class="${a}"\n                    style="width: ${e}px; height: ${t}px; background-image: url(${o.url})"\n                    click-emit="setting_wallpaper_toggle:${n}"\n                >${r}</div>\n                `})).join("")})),window.setting_config_input.value=JSON.stringify(n.config,null,2)},toggle:e=>{void 0===e&&(e=!b.isOpen),b.isOpen=e,e?(window.setting_box.removeClass("hidden"),b.render()):window.setting_box.addClass("hidden")}};s.on("setting_close",(()=>{b.toggle(!1)})),s.on("setting_open",(()=>{b.toggle(!0)})),s.on("setting_backup",(async()=>{const e=new Date,t=await chrome.storage.local.get(),o={};o.local=t,o.storage=window.localStorage;const n=new Blob([JSON.stringify(o)],{type:"text/plain"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download="sein-backup-"+e.toLocaleDateString().replace(/\//g,"-")+".json",r.click(),URL.revokeObjectURL(a)})),s.on("setting_restore",(()=>{const e=document.createElement("input");e.type="file",e.addEventListener("change",(()=>{const t=e.files[0],o=new FileReader;o.addEventListener("load",(async()=>{const{local:e,storage:t,notes:n}=JSON.parse(o.result);if(t)for(const e of Object.keys(t))window.localStorage[e]=t[e];e&&await chrome.storage.local.set(e),n&&(g.notes=n,g.save()),window.alert("Restore completed"),window.location.reload()})),o.readAsText(t)}),{once:!0}),e.click()})),s.on("setting_config_save",(()=>{try{const e=JSON.parse(window.setting_config_input.value);n.config=e}catch(e){return console.error(e),window.alert("Parse and save config error")}window.alert("Save config success")})),s.on("setting_wallpaper_toggle",((e,{target:t})=>{e=+e,chrome.storage.local.get("wallpapers",(({wallpapers:o})=>{const n=-1!==t.className.indexOf("active");o[e].active=!n,r.cache(o),chrome.storage.local.set({wallpapers:o}),n?t.removeClass("active"):t.addClass("active")}))})),s.on("setting_wallpaper_edit",((e,{target:t})=>{e=+e;const o=document.createElement("input");o.type="file",o.addEventListener("change",(()=>{const n=o.files[0],a=new FileReader;a.addEventListener("load",(async()=>{if(n.type.startsWith("video/")){const o=document.createElement("video"),i=document.createElement("source"),s=document.createElement("canvas"),l=s.getContext("2d");return o.className="invisible",s.className="invisible",i.setAttribute("src",a.result),i.setAttribute("type",n.type),o.appendChild(i),window.setting_box.appendChild(o),void o.addEventListener("canplaythrough",(()=>{setTimeout((async()=>{s.width=o.videoWidth,s.height=o.videoHeight,window.setting_box.appendChild(s),l.drawImage(o,0,0,o.videoWidth,o.videoHeight);const{wallpapers:n}=await chrome.storage.local.get("wallpapers"),i=s.toDataURL("image/jpeg");window.setting_box.removeChild(o),window.setting_box.removeChild(s),n[e].url=i,n[e].video=e,r.cache(n),chrome.storage.local.set({wallpapers:n,[`wallpaper_videos_${e}`]:a.result}),t.parentElement.style.backgroundImage=`url(${i})`}),200)}))}if(n.type.startsWith("image/")){const{wallpapers:o}=await chrome.storage.local.get("wallpapers");o[e].url=a.result,r.cache(o),chrome.storage.local.set({wallpapers:o,[`wallpaper_videos_${e}`]:""}),t.parentElement.style.backgroundImage=`url(${a.result})`}else alert("Only accept image or video")})),a.readAsDataURL(n)}),{once:!0}),o.click()})),window.holder={w_w:window.document.documentElement.clientWidth,w_h:window.document.documentElement.clientHeight,code_tables:[{code:"date==",value:(new Date).toLocaleDateString()},{code:"time==",value:(new Date).toLocaleTimeString()},{code:"now==",value:(new Date).toLocaleString()},{code:"name_(.+?)==",value:"Hi sir, $ <3"}]},window.addEventListener("resize",(()=>{holder.w_w=window.document.documentElement.clientWidth,holder.w_h=window.document.documentElement.clientHeight})),r.boot(),g.boot(),f.boot(),d.click(),n.config=Object.assign({log_level:"error",number_of_workspace:2},n.config),n.workspace?(-1===n.workspace&&n.workspace++,window.btn_switch_workspace.innerHTML=n.workspace):window.btn_switch_workspace.innerHTML="0",t.log_level=n.config.log_level})()})();